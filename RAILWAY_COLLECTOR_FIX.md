# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Collector –Ω–∞ Railway

## –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞: `[CollectorApi] Health check failed: fetch failed`

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ server –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ collector (–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤).

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–ë—ã–ª–æ**: Server –∏ collector –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, server –º–æ–≥ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ collector.

**–°—Ç–∞–ª–æ**: 
- Collector –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
- –°–∫—Ä–∏–ø—Ç –∂–¥–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ collector (–¥–æ 30 —Å–µ–∫—É–Ω–¥)
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è server

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–ë—ã–ª–æ**: Server –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è –∫ collector –ø–æ `http://0.0.0.0:8888`

**–°—Ç–∞–ª–æ**: 
- –í Docker/production: `http://localhost:8888`
- –í development: `http://0.0.0.0:8888`

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ collector

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ collector –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º server:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `netcat` –∏–ª–∏ `curl` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ä—Ç–∞
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: 30 —Å–µ–∫—É–Ω–¥
- –ï—Å–ª–∏ collector –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è - –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π

## üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### docker-entrypoint.sh

```bash
# –ó–∞–ø—É—Å–∫ collector
{ node /app/collector/index.js } &
COLLECTOR_PID=$!

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–¥–æ 30 —Å–µ–∫—É–Ω–¥)
for i in {1..30}; do
    if nc -z localhost ${COLLECTOR_PORT} || curl -s http://localhost:${COLLECTOR_PORT}/ping; then
        echo "‚úì Collector is ready"
        break
    fi
    sleep 1
done

# –ó–∞–ø—É—Å–∫ server —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ collector
{ node /app/server/index.js } &
```

### server/utils/collectorApi/index.js

```javascript
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç localhost –≤ Docker/production, 0.0.0.0 –≤ development
const collectorHost = process.env.NODE_ENV === "production" || process.env.ANYTHING_LLM_RUNTIME === "docker" 
  ? "localhost" 
  : "0.0.0.0";
this.endpoint = `http://${collectorHost}:${process.env.COLLECTOR_PORT || 8888}`;
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Railway

### 1. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git add .
git commit -m "Fix collector startup sequence for Railway"
git push
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ Railway

1. –û—Ç–∫—Ä–æ–π—Ç–µ Railway Dashboard
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Deployments"
4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç—Ä–∏ —Ç–æ—á–∫–∏ (‚ãØ) —Ä—è–¥–æ–º —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –¥–µ–ø–ª–æ–µ–º
5. –í—ã–±–µ—Ä–∏—Ç–µ "Redeploy"

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:

```
Starting collector on port 8888...
Waiting for collector to be ready...
‚úì Collector is ready on port 8888
Starting server on port XXXX...
Document processor app listening on port 8888
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à Railway URL
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
3. –û—à–∏–±–∫–∞ "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway

–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:
- ‚úÖ `"Starting collector on port 8888..."`
- ‚úÖ `"‚úì Collector is ready on port 8888"`
- ‚úÖ `"Document processor app listening on port 8888"`
- ‚ùå `"‚úó Collector failed to start after 30 seconds"`

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
```env
NODE_ENV=production
COLLECTOR_PORT=8888  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8888
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞:
- Collector –ø—Ä–æ—Ü–µ—Å—Å
- Server –ø—Ä–æ—Ü–µ—Å—Å

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ù–µ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π Dockerfile** - –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
2. **–ù–µ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å** - collector –∏ server —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ
3. **–ü–æ—Ä—Ç—ã**: 
   - Server –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PORT` (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   - Collector –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `COLLECTOR_PORT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8888)
4. **–°–≤—è–∑—å**: Server –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ collector —á–µ—Ä–µ–∑ `localhost:8888` –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ Collector –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
- ‚úÖ Server –∂–¥–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ collector
- ‚úÖ Server —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ collector
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π "Health check failed"

## üÜò –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –¥–µ–ø–ª–æ–π –Ω–∞ Railway
